<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Allocation Portal</title>
    <link rel="stylesheet" href="cu.css">
</head>
<body>
    <!-- Header -->
    <div class="header-container">
        <header class="header">
            <div class="logo">
                <img src="cu logo.png" alt="Logo">
                <span class="logo-text">Classroom Allocation Portal</span>
            </div>
            <button class="mobile-menu-toggle">‚ò∞</button>
            <div class="nav-links">
                <a href="#" class="active">Dashboard</a>
                <a href="booking.html">Bookings</a>
                <a href="settings.html">Settings</a>
            </div>           
        </header>
    </div>

    <!-- Hero Section -->
    <div class="hero-container">
        <section class="hero">
            <h1>Welcome to CU Classroom Allocation Portal</h1>
            <p>Efficiently manage Lecture room bookings</p>
        </section>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- User Info -->
        <div class="user-info">
            <div class="user-avatar"><span>üìö</span></div>
            <div class="user-details">
                <h3 id="userFullName"></h3>
                <p id="userRoleInfo"></p>
                <p>Welcome back, manage your classroom allocations.</p>
            </div>
        </div>
        
        <!-- New Booking -->
        <div class="new-booking">
            <div class="booking-icon">üìÖ</div>
            <div class="booking-form">
                <h2>Book a Lecture Hall</h2>
                <p>Fill in the details to book a lecture room</p>
                <div class="booking-actions">
                    <button class="btn" onclick="window.location.href='booking.html'">Book Room</button>
                </div>
            </div>
        </div>

        <!-- Manage Bookings -->
        <section class="manage-bookings">
            <h2 class="section-title">Manage Bookings</h2>
            <p class="section-subtitle">View and make changes to active bookings</p>
            <div class="room-cards" id="userBookings">
                <!-- Dynamic content -->
            </div>
            <div class="booking-details">
                <div class="booking-detail">
                    <h4>Next Booking</h4>
                    <p id="nextBooking">Loading...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>¬© 2025 Classroom Allocation Portal. All Rights Reserved</p><br><p>Group 5</p>
        </div>
    </footer>

    <script src="user-display.js"></script>
    <script src="booking-system.js"></script>
    <script src="cu.js"></script>
    <script>
        // Display user's bookings
        function displayUserBookings() {
            const auth = JSON.parse(localStorage.getItem('auth')) || {};
            const bookings = JSON.parse(localStorage.getItem('bookings')) || { 
                upcoming: [], 
                current: [] 
            };
            
            // Filter bookings for current user
            const userBookings = [...bookings.upcoming, ...bookings.current]
                .filter(booking => booking.bookedBy === auth.username)
                .sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`));
            
            const container = document.getElementById('userBookings');
            const nextBookingEl = document.getElementById('nextBooking');
            
            // Clear previous content
            container.innerHTML = '';
            
            if (userBookings.length === 0) {
                container.innerHTML = '<p class="no-bookings">No active bookings found</p>';
                nextBookingEl.textContent = 'No upcoming bookings';
                return;
            }
            
            // Display next booking
            nextBookingEl.textContent = 
                `${userBookings[0].roomId} - ${userBookings[0].date} (${userBookings[0].startTime} to ${userBookings[0].endTime})`;
            
            // Create booking cards
            userBookings.forEach(booking => {
                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-icon">üèõÔ∏è</div>
                    <h3>${booking.roomId}</h3>
                    <p>Date: ${booking.date}</p>
                    <p>Time: ${booking.startTime} - ${booking.endTime}</p>
                    <p>Purpose: ${booking.purpose || 'Not specified'}</p>
                    <button class="btn btn-cancel" 
                            onclick="cancelBooking(${booking.timestamp})">
                        Cancel Booking
                    </button>
                `;
                container.appendChild(card);
            });
        }
        
        // Cancel booking function (add to global scope)
        function cancelBooking(timestamp) {
            const bookings = JSON.parse(localStorage.getItem('bookings'));
            bookings.upcoming = bookings.upcoming.filter(b => b.timestamp !== timestamp);
            bookings.current = bookings.current.filter(b => b.timestamp !== timestamp);
            localStorage.setItem('bookings', JSON.stringify(bookings));
            
            // Refresh display
            displayUserBookings();
            window.dispatchEvent(new StorageEvent('storage', { key: 'bookings' }));
        }
        
        // Initialize on page load + sync across tabs
        document.addEventListener('DOMContentLoaded', displayUserBookings);
        window.addEventListener('storage', (e) => {
            if (e.key === 'bookings') displayUserBookings();
        });
        
        // Make cancelBooking available globally
        window.cancelBooking = cancelBooking;
        </script>
</body>
</html>